name: Codacy Variation Fallback

# This workflow injects a success check on 'Codacy Coverage Variation' when the check is not reported by Codacy,
# so it can avoid bloking auto-merging on Pull Requests that has a check success requirement on it.

# Examples where 'Codacy Coverage Variation' is not reported by Codacy:
# - Modification on just a test class, and your test classes are ignored at 'codacy.yml'.
# - Modification of 'README.md', which has no coverage.
# - Modification of a GitHub Action workflow, which has no coverage.

# In those cases, this workflow will bypass the 'Codacy Coverage Variation' check, allowing the PR to auto-merge.

on:
  pull_request:
    branches: [ "master", "main" ]

permissions:
  checks: write
  contents: read

jobs:
  bypass_codacy_variation:
    runs-on: ubuntu-latest
    steps:
    
      # Verify if there are changes on relevant files
      # relevant_files will be:
      # - 'true' when there is at least one file that will trigger the 'Codacy Coverage Variation' check
      # - will be false otherwise.
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: | 
            has_code_changes:
              - "src/main/**/*.java"
              # Excluded files from Codacy Coverage Variation
            has_non_coverable_changes:
              - "**/*.md"
              - "**/*.yml"
              - ".github/**"
            
      # Bypass the 'Codacy Coverage Variation' when there are no coverable files able to trigger it.
      - name: Create Success Check for Variation
        if: steps.changes.outputs.has_code_changes == 'false' && steps.changes.outputs.has_non_coverable_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const checkName = 'Codacy Coverage Variation';
            console.log(`Reporting manual success for: ${checkName}`);
            
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: checkName,
              head_sha: context.payload.pull_request.head.sha,
              status: 'completed',
              conclusion: 'success',
              output: {
                title: 'Skipped by Dynamic Exclusion',
                summary: 'All modified files workflows or they are excluded by codacy.yml. Reported bypassed success check.'
              }
            });
