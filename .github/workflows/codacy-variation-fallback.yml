name: Codacy Variation Fallback

# This workflow injects a success check on 'Codacy Coverage Variation' when the check is not reported by Codacy,
# so it can avoid bloking auto-merging on Pull Requests that has a check success requirement on it.

# Examples where 'Codacy Coverage Variation' is not reported by Codacy:
# - Modification on just a test class, and your test classes are ignored at 'codacy.yml'.
# - Modification of 'README.md', which has no coverage.
# - Modification of a GitHub Action workflow, which has no coverage.

# In those cases, this workflow will bypass the 'Codacy Coverage Variation' check, allowing the PR to auto-merge.

on:
  pull_request:
    branches: [ "master", "main" ]

permissions:
  checks: write
  contents: read

jobs:
  bypass_codacy_variation:
    runs-on: ubuntu-latest
    steps:

      # Checkout Code to obtain 'codacy.yml' configuration
      - name: Checkout Code
        uses: actions/checkout@v6

      # Parse 'codacy.yml' exclusions
      - name: Parse codacy.yml exclusions
        id: parse-codacy-exclusions
        run: |
          
          FILE_NAME=".codacy.yml"
          
          if [ ! -f "$FILE_NAME" ]; then
            echo "::warning::File $FILE_NAME not found. Basic ignored configuration file will be used."
          fi

          
          # Extract excluded paths and add the 'codacy.yml' file itself
          FORMATTED_LIST="relevant_files:"$'\n'
          FORMATTED_LIST="$FORMATTED_LIST"$'\n'"- \"**\""    # 1. Incluir todo lo visible
          FORMATTED_LIST="$FORMATTED_LIST"$'\n'"- \".*/**\"" # 2. Incluir todo lo oculto (ej. .github, .vscode, .codacy.yml)

          # Format the list
          while IFS= read -r line; do
            if [[ -n "$line" ]]; then
            # Generamos la negaci√≥n: - "!ruta"
            # Mantenemos las comillas dobles para evitar el error de alias
            FORMATTED_LIST="$FORMATTED_LIST"$'\n'"- \"!${line}\""
          fi
          done <<< "$ALL_PATHS"

          # Save the result on a variable
          {
            echo 'filters<<EOF'
            echo "$FORMATTED_LIST"
            echo 'EOF'
          } >> $GITHUB_OUTPUT
          
          echo "Generated Filters (Final YAML Format):"
          echo "$FORMATTED_LIST"
          
      # Verify if there are changes on relevant files
      # relevant_files will be:
      # - 'true' when there is at least one file that will trigger the 'Codacy Coverage Variation' check
      # - will be false otherwise.
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            ${{ steps.parse-codacy-exclusions.outputs.filters }}

      # Bypass the 'Codacy Coverage Variation' when there are no relevant files able to trigger it.
      - name: Create Success Check for Variation
        if: steps.changes.outputs.relevant_files == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const checkName = 'Codacy Coverage Variation';
            console.log(`Reporting manual success for: ${checkName}`);
            
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: checkName,
              head_sha: context.payload.pull_request.head.sha,
              status: 'completed',
              conclusion: 'success',
              output: {
                title: 'Skipped by Dynamic Exclusion',
                summary: 'All modified files workflows or they are excluded by codacy.yml. Reported bypassed success check.'
              }
            });
